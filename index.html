<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2hhcm7DqSdzIFJlY2lwZXMiLCJzaG9ydF9uYW1lIjoiUmVjaXBlcyIsImRlc2NyaXB0aW9uIjoiQSBwZXJzb25hbCByZWNpcGUgZGF0YWJhc2UgYXBwbGljYXRpb24uIExvZyB5b3VyIGZhdm9yaXRlIHJlY2lwZXMgZnJvbSBwYXBlciB0byBhIGRpZ2l0YWwgZm9ybWF0LCB2aWV3IHRoZW0sIGFuZCBhZGp1c3QgaW5ncmVkaWVudCBxdWFudGl0aWVzIG9uIHRoZSBmbHkuIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiM2NEM3Q0MiLCJpY29ucyI6W3sic3JjIjoiY3JvcHBlZC5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=" />
    <meta name="theme-color" content="#64C7CC" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Sharn√©'s Recipes" />
    <link rel="apple-touch-icon" href="cropped.png" />
    <title>Sharn√©'s Recipes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
      .font-fancy {
        font-family: 'Playfair Display', serif;
      }
      /* Initial theme variables */
      :root {
        --color-bg-primary: #111827;
        --color-bg-secondary: #1f2937;
        --color-bg-tertiary: #374151;
        --color-bg-input: #374151;
        --color-text-primary: #f9fafb;
        --color-text-secondary: #d1d5db;
        --color-text-tertiary: #9ca3af;
        --color-border-primary: #374151;
        --color-border-secondary: #4b5563;
        --color-accent: #64C7CC;
        --color-accent-text: #64C7CC;
        --color-danger: #EF4444;
        --color-danger-hover: #DC2626;
      }
      /* Prevent iOS auto-zoom on form elements without disabling user zoom. */
      /* Safari on iOS zooms if font-size is less than 16px. */
      select,
      textarea,
      input[type="text"],
      input[type="password"],
      input[type="datetime"],
      input[type="datetime-local"],
      input[type="date"],
      input[type="month"],
      input[type="time"],
      input[type="week"],
      input[type="number"],
      input[type="email"],
      input[type="url"],
      input[type="search"],
      input[type="tel"],
      input[type="color"] {
        font-size: max(1rem, 16px);
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.1.1/client",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module">
      import React, { useState, useEffect, useMemo, useRef } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- Start of inlined constants.ts ---
      const DEFAULT_UNITS = [
        { id: 'GRAM', label: 'Gram(s)' },
        { id: 'KILOGRAM', label: 'Kilogram(s)' },
        { id: 'MILLILITER', label: 'Milliliter(s)' },
        { id: 'LITER', label: 'Liter(s)' },
        { id: 'TEASPOON', label: 'Teaspoon(s)' },
        { id: 'TABLESPOON', label: 'Tablespoon(s)' },
        { id: 'CUP', label: 'Cup(s)' },
        { id: 'FLUID_OUNCE', label: 'Fluid Ounce(s)' },
        { id: 'OUNCE', label: 'Ounce(s)' },
        { id: 'POUND', label: 'Pound(s)' },
        { id: 'PINT', label: 'Pint(s)' },
        { id: 'QUART', label: 'Quart(s)' },
        { id: 'GALLON', label: 'Gallon(s)' },
        { id: 'PINCH', label: 'Pinch(es)' },
        { id: 'PIECE', label: 'Piece(s)' },
        { id: 'CLOVE', label: 'Clove(s)' },
        { id: 'TO_TASTE', label: 'To Taste' },
      ];

      const FOOD_EMOJIS = [
        'üå∂Ô∏è', 'üç™', 'üçó', 'üçï', 'üçî', 'üçü', 'üçú', 'üç£', 'üç∞', 'üç©', 'üéÇ',
        'ü•ë', 'ü•¶', 'ü•ï', 'üåΩ', 'üçá', 'üçâ', 'üçì', 'üçë', 'ü•ù', 'üçç', 'ü••',
        'ü•©', 'ü•ì', 'ü•ö', 'üßÄ', 'üçû', 'ü•ê', 'ü•®', 'ü•û', 'üßá', 'üçø', 'ü•£',
        'ü•ó', 'üåÆ', 'üåØ', 'ü•ò', 'üç≤', 'üçõ', 'üçô', 'üç§', 'üç¶', 'üç´', 'üç¨',
        '‚òï', 'üçµ', 'üç∑', 'üç∫', 'üçπ', 'üç¥', 'ü•Ñ', 'üî™', 'üßÇ'
      ].filter((v, i, a) => a.indexOf(v) === i);

      const DEFAULT_THEME = {
        mode: 'dark',
        accentColor: '#64C7CC',
        backgroundColor: '#111827',
      };

      // --- Start of inlined hooks/useLocalStorage.ts ---
      function useLocalStorage(key, initialValue) {
        const [storedValue, setStoredValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        useEffect(() => {
          try {
            const valueToStore = JSON.stringify(storedValue);
            window.localStorage.setItem(key, valueToStore);
          } catch (error) {
            console.error(error);
          }
        }, [key, storedValue]);

        return [storedValue, setStoredValue];
      }

      // --- Start of inlined components/icons.tsx ---
      const PlusIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 4.5v15m7.5-7.5h-15" })
          )
      );
      
      const MinusIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M18 12H6" })
          )
      );

      const TrashIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" })
          )
      );
      
      const XMarkIcon = ({ className = "w-4 h-4" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 2, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M6 18L18 6M6 6l12 12" })
          )
      );

      const ChevronLeftIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M15.75 19.5 8.25 12l7.5-7.5" })
          )
      );

      const PencilIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" })
          )
      );

      const SearchIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" })
          )
      );

      const ChevronDownIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "m19.5 8.25-7.5 7.5-7.5-7.5" })
          )
      );
      
      const ChevronUpIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "m4.5 15.75 7.5-7.5 7.5 7.5" })
          )
      );

      const CloudUploadIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" })
          )
      );

      const CloudDownloadIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" })
          )
      );
      
      const BurgerMenuIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" })
          )
      );
      
      const ShoppingBagIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.658-.463 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007Z" })
          )
      );

      const ClockIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" })
          )
      );
      
      const ArrowUpTrayIcon = ({ className = "w-6 h-6" }) => (
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor", className: className },
              React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" })
          )
      );

      // --- Start of inlined components/ImportConfirmation.tsx ---
      const ImportConfirmation = ({ data, onConfirm, onCancel }) => {
          const importedRecipes = useMemo(() => data.recipes || [], [data.recipes]);
          const importedSections = useMemo(() => data.sections || [], [data.sections]);
          const importedUnits = useMemo(() => data.units || [], [data.units]);
          const importedShoppingList = useMemo(() => data.shoppingList || [], [data.shoppingList]);

          const [selectedRecipeIds, setSelectedRecipeIds] = useState(() => new Set(importedRecipes.map(r => r.id)));
          const [selectedSectionIds, setSelectedSectionIds] = useState(() => new Set(importedSections.map(s => s.id)));
          const [selectedUnitIds, setSelectedUnitIds] = useState(() => new Set(importedUnits.map(u => u.id)));
          const [selectedShoppingListIds, setSelectedShoppingListIds] = useState(() => new Set(importedShoppingList.map(i => i.id)));

          const createToggleHandler = (setter) => (id) => {
              setter(prev => {
                  const newSet = new Set(prev);
                  if (newSet.has(id)) newSet.delete(id);
                  else newSet.add(id);
                  return newSet;
              });
          };

          const createSelectAllHandler = (setter, items) => (select) => {
              setter(select ? new Set(items.map(item => item.id)) : new Set());
          };

          const handleRecipeToggle = createToggleHandler(setSelectedRecipeIds);
          const handleSectionToggle = createToggleHandler(setSelectedSectionIds);
          const handleUnitToggle = createToggleHandler(setSelectedUnitIds);
          const handleShoppingListToggle = createToggleHandler(setSelectedShoppingListIds);

          const handleSelectAllRecipes = createSelectAllHandler(setSelectedRecipeIds, importedRecipes);
          const handleSelectAllSections = createSelectAllHandler(setSelectedSectionIds, importedSections);
          const handleSelectAllUnits = createSelectAllHandler(setSelectedUnitIds, importedUnits);
          const handleSelectAllShoppingList = createSelectAllHandler(setSelectedShoppingListIds, importedShoppingList);
          
          const handleConfirm = () => {
              const selectedRecipes = importedRecipes.filter(r => selectedRecipeIds.has(r.id));
              const selectedSections = importedSections.filter(s => selectedSectionIds.has(s.id));
              const selectedUnits = importedUnits.filter(u => selectedUnitIds.has(u.id));
              const selectedShoppingList = importedShoppingList.filter(i => selectedShoppingListIds.has(i.id));
              onConfirm(selectedRecipes, selectedSections, selectedUnits, selectedShoppingList);
          };

          const CheckboxList = ({ title, items, selectedIds, onToggle, onSelectAll, itemLabelProp, emptyText }) => (
              React.createElement('div', null,
                  React.createElement('div', { className: "flex justify-between items-center mb-4" },
                      React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)]" }, `${title} (${selectedIds.size}/${items.length})`),
                      React.createElement('div', { className: "flex gap-2 text-sm" },
                          React.createElement('button', { type: "button", onClick: () => onSelectAll(true), className: "text-[var(--color-accent-text)] hover:underline" }, "All"),
                          React.createElement('button', { type: "button", onClick: () => onSelectAll(false), className: "text-[var(--color-accent-text)] hover:underline" }, "None")
                      )
                  ),
                  React.createElement('div', { className: "max-h-60 overflow-y-auto space-y-2 p-4 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)]" },
                      items.length > 0 ? items.map(item => (
                          React.createElement('label', { key: item.id, className: "flex items-center p-2 rounded-md hover:bg-[var(--color-bg-tertiary)] cursor-pointer" },
                              React.createElement('input', {
                                  type: "checkbox",
                                  checked: selectedIds.has(item.id),
                                  onChange: () => onToggle(item.id),
                                  className: "w-5 h-5 rounded bg-[var(--color-bg-tertiary)] border-[var(--color-border-secondary)] text-[var(--color-accent)] focus:ring-[var(--color-accent)]"
                              }),
                              React.createElement('span', { className: "ml-3 text-[var(--color-text-primary)] truncate" }, item[itemLabelProp])
                          )
                      )) : React.createElement('p', { className: "text-[var(--color-text-tertiary)] text-center" }, emptyText)
                  )
              )
          );

          return React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-8" },
              React.createElement('h1', { className: "text-4xl font-bold text-[var(--color-text-primary)] mb-6" }, "Confirm Import"),
              React.createElement('div', { className: "bg-[var(--color-bg-secondary)] p-8 rounded-lg shadow-lg border border-[var(--color-border-primary)] space-y-8" },
                  React.createElement(CheckboxList, {
                      title: 'Recipes',
                      items: importedRecipes,
                      selectedIds: selectedRecipeIds,
                      onToggle: handleRecipeToggle,
                      onSelectAll: handleSelectAllRecipes,
                      itemLabelProp: 'name',
                      emptyText: "No recipes found in file."
                  }),
                  React.createElement(CheckboxList, {
                      title: 'Sections',
                      items: importedSections,
                      selectedIds: selectedSectionIds,
                      onToggle: handleSectionToggle,
                      onSelectAll: handleSelectAllSections,
                      itemLabelProp: 'name',
                      emptyText: "No sections found in file."
                  }),
                  React.createElement(CheckboxList, {
                      title: 'Measurement Units',
                      items: importedUnits,
                      selectedIds: selectedUnitIds,
                      onToggle: handleUnitToggle,
                      onSelectAll: handleSelectAllUnits,
                      itemLabelProp: 'label',
                      emptyText: "No units found in file."
                  }),
                   React.createElement(CheckboxList, {
                      title: 'Shopping List Items',
                      items: importedShoppingList,
                      selectedIds: selectedShoppingListIds,
                      onToggle: handleShoppingListToggle,
                      onSelectAll: handleSelectAllShoppingList,
                      itemLabelProp: 'text',
                      emptyText: "No shopping list items found."
                  }),
                  React.createElement('div', { className: "flex justify-end gap-4 pt-4 border-t border-[var(--color-border-primary)]" },
                      React.createElement('button', { onClick: onCancel, className: "bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-6 rounded-md" }, "Cancel"),
                      React.createElement('button', { onClick: handleConfirm, className: "bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-2 px-6 rounded-md" }, "Import Selected")
                  )
              )
          );
      };

      // --- Start of inlined components/RecipeForm.tsx ---
      const RecipeForm = ({ initialRecipe, sections, units, onSave, onCancel, onAddSection, showConfirmDialog, showAddUnitDialog }) => {
        const [name, setName] = useState('');
        const [description, setDescription] = useState('');
        const [categories, setCategories] = useState([]);
        const [newCategoryName, setNewCategoryName] = useState('');
        const [emojiString, setEmojiString] = useState('');
        const [ingredients, setIngredients] = useState([]);
        const [steps, setSteps] = useState([]);
        const [selectedSectionIds, setSelectedSectionIds] = useState(new Set());
        const [newSectionName, setNewSectionName] = useState('');
        const ADD_NEW_UNIT_VALUE = '__add_new__';

        useEffect(() => {
          if (initialRecipe) {
            setName(initialRecipe.name);
            setDescription(initialRecipe.description || '');
            setCategories(initialRecipe.categories || []);
            setEmojiString(initialRecipe.emojis ? initialRecipe.emojis.join('') : '');
            setIngredients(initialRecipe.ingredients);

            const initialSteps = Array.isArray(initialRecipe.steps) ? initialRecipe.steps : [];
            const processedSteps = initialSteps.map((step, index) => {
                if (typeof step === 'string') {
                    return { id: `s_${Date.now()}_${index}`, text: step, categoryId: undefined };
                }
                return step.id ? step : { ...step, id: `s_${Date.now()}_${index}` };
            });
            setSteps(processedSteps.length > 0 ? processedSteps : [{ id: `s_new_${Date.now()}`, text: '', categoryId: undefined }]);

            const currentSectionIds = new Set();
            if (initialRecipe.sectionIds) {
                initialRecipe.sectionIds.forEach(id => currentSectionIds.add(id));
            } else if (initialRecipe.sectionId) {
                currentSectionIds.add(initialRecipe.sectionId);
            }
            setSelectedSectionIds(currentSectionIds);
          } else {
            setName('');
            setDescription('');
            setCategories([]);
            setEmojiString('');
            setIngredients([{ id: `new_ing_${Date.now()}`, name: '', quantity: '', unit: units[0]?.id || '', categoryId: undefined }]);
            setSteps([{ id: `new_step_${Date.now()}`, text: '', categoryId: undefined }]);
            setSelectedSectionIds(new Set());
          }
          setNewSectionName('');
          setNewCategoryName('');
        }, [initialRecipe]);
        
        const addEmoji = (emoji) => {
          setEmojiString(prev => prev + emoji);
        };
        
        const handleAddCategory = () => {
            const trimmedName = newCategoryName.trim();
            if (!trimmedName || categories.some(c => c.name.toLowerCase() === trimmedName.toLowerCase())) {
                setNewCategoryName('');
                return;
            }
            const newCategory = { id: `cat_${Date.now()}`, name: trimmedName };
            setCategories(prev => [...prev, newCategory]);
            setNewCategoryName('');
        };
        
        const handleRemoveCategory = (id) => {
            setCategories(prev => prev.filter(c => c.id !== id));
            setIngredients(prev => prev.map(ing => ing.categoryId === id ? { ...ing, categoryId: undefined } : ing));
            setSteps(prev => prev.map(step => step.categoryId === id ? { ...step, categoryId: undefined } : step));
        };

        const handleIngredientChange = (index, field, value) => {
          if (field === 'unit' && value === ADD_NEW_UNIT_VALUE) {
            showAddUnitDialog(newUnit => {
              handleIngredientChange(index, 'unit', newUnit.id);
            });
            return;
          }
          const newIngredients = ingredients.map((ing, i) => 
              i === index ? { ...ing, [field]: value } : ing
          );
          setIngredients(newIngredients);
        };

        const addIngredient = () => {
          const lastCategoryId = ingredients.length > 0 ? ingredients[ingredients.length - 1].categoryId : undefined;
          setIngredients([...ingredients, { id: `new_ing_${Date.now()}`, name: '', quantity: '', unit: units[0]?.id || '', categoryId: lastCategoryId }]);
        };

        const removeIngredient = (index) => {
          const ingredientToRemove = ingredients[index];
          if (!ingredientToRemove.name.trim() && !String(ingredientToRemove.quantity).trim()) {
            setIngredients(prev => prev.filter((_, i) => i !== index));
            return;
          }
          const ingredientName = ingredientToRemove.name || 'this ingredient';
          showConfirmDialog(
              'Delete Ingredient',
              `Are you sure you want to delete "${ingredientName}"?`,
              () => {
                  setIngredients(currentIngredients => currentIngredients.filter((_, i) => i !== index));
              }
          );
        };
        
        const handleStepChange = (index, field, value) => {
            const newSteps = steps.map((s, i) =>
                i === index ? { ...s, [field]: value } : s
            );
            setSteps(newSteps);
        };

        const addStep = () => {
          const lastCategoryId = steps.length > 0 ? steps[steps.length - 1].categoryId : undefined;
          setSteps([...steps, { id: `new_step_${Date.now()}`, text: '', categoryId: lastCategoryId }]);
        };

        const removeStep = (index) => {
          const stepToRemove = steps[index];
          if (!stepToRemove.text.trim()) {
            setSteps(prev => prev.filter((_, i) => i !== index));
            return;
          }
          const stepText = stepToRemove.text;
          const shortStepText = stepText.length > 40 ? `${stepText.substring(0, 40)}...` : stepText;
          showConfirmDialog(
              'Delete Step',
              `Are you sure you want to delete step ${index + 1} ("${shortStepText}")?`,
              () => {
                  setSteps(currentSteps => currentSteps.filter((_, i) => i !== index));
              }
          );
        };

        const handleSectionToggle = (sectionId) => {
            setSelectedSectionIds(prev => {
                const newSet = new Set(prev);
                if (newSet.has(sectionId)) {
                    newSet.delete(sectionId);
                } else {
                    newSet.add(sectionId);
                }
                return newSet;
            });
        };

        const handleAddSection = () => {
            const trimmedName = newSectionName.trim();
            if (!trimmedName) return;
            const newSection = onAddSection(trimmedName);
            if (newSection) {
                setSelectedSectionIds(prev => {
                    const newSet = new Set(prev);
                    newSet.add(newSection.id);
                    return newSet;
                });
                setNewSectionName('');
            }
        };
        
        const handleSubmit = (e) => {
          e.preventDefault();
          if (!name.trim()) {
              alert("Please enter a recipe name.");
              return;
          }

          const finalIngredients = ingredients.filter(ing => ing.name.trim() !== '');
          const finalSteps = steps.filter(step => step.text.trim() !== '');

          const recipeData = {
              id: initialRecipe?.id,
              name,
              description,
              categories,
              emojis: [...emojiString],
              ingredients: finalIngredients,
              steps: finalSteps,
              sectionIds: Array.from(selectedSectionIds),
          };

          onSave(recipeData);
        };

        return React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-8" },
          React.createElement('h1', { className: "text-4xl font-bold text-[var(--color-text-primary)] mb-8" }, initialRecipe ? 'Edit Recipe' : 'Add New Recipe'),
          React.createElement('form', { onSubmit: handleSubmit, className: "bg-[var(--color-bg-secondary)] p-8 rounded-lg shadow-lg border border-[var(--color-border-primary)]" },
            React.createElement('div', null,
              React.createElement('label', { htmlFor: "recipe-name", className: "block text-lg font-medium text-[var(--color-text-secondary)] mb-2" }, "Recipe Name"),
              React.createElement('input', {
                id: "recipe-name",
                type: "text",
                value: name,
                onChange: (e) => setName(e.target.value),
                placeholder: "e.g., Chocolate Chip Cookies",
                className: "w-full p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]",
                required: true
              })
            ),
            React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
              React.createElement('label', { className: "block text-lg font-medium text-[var(--color-text-secondary)] mb-2" }, "Sections"),
              React.createElement('div', { className: "space-y-2 p-4 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)] max-h-48 overflow-y-auto" },
                sections.length > 0 
                  ? sections.map(section => React.createElement('label', { key: section.id, className: "flex items-center cursor-pointer" },
                      React.createElement('input', {
                        type: "checkbox",
                        checked: selectedSectionIds.has(section.id),
                        onChange: () => handleSectionToggle(section.id),
                        className: "w-5 h-5 rounded bg-[var(--color-bg-tertiary)] border-[var(--color-border-secondary)] text-[var(--color-accent)] focus:ring-[var(--color-accent)]"
                      }),
                      React.createElement('span', { className: "ml-3 text-[var(--color-text-primary)]" }, section.name)
                    ))
                  : React.createElement('p', { className: "text-[var(--color-text-tertiary)]" }, "No sections created yet.")
              ),
              React.createElement('div', { className: "flex flex-col sm:flex-row items-center gap-2 mt-3" },
                React.createElement('input', {
                  type: "text",
                  value: newSectionName,
                  onChange: e => setNewSectionName(e.target.value),
                  placeholder: "Create a new section...",
                  className: "w-full sm:flex-grow p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                }),
                React.createElement('button', {
                  type: "button",
                  onClick: handleAddSection,
                  className: "w-full sm:w-auto bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-3 px-4 rounded-md flex-shrink-0"
                }, "Add Section")
              )
            ),
            React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
              React.createElement('label', { htmlFor: "recipe-notes", className: "block text-lg font-medium text-[var(--color-text-secondary)] mb-2" }, "Notes"),
              React.createElement('textarea', {
                id: "recipe-notes",
                value: description,
                onChange: (e) => setDescription(e.target.value),
                rows: 4,
                placeholder: "Add any tips, variations, or notes for this recipe...",
                className: "w-full p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
              })
            ),
            React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
              React.createElement('div', { className: "flex items-center gap-4 mb-2" },
                React.createElement('label', { className: "text-lg font-medium text-[var(--color-text-secondary)] flex-shrink-0" }, "Emojis"),
                React.createElement('div', { className: "flex-grow flex items-center bg-[var(--color-bg-primary)] border border-[var(--color-border-primary)] rounded-md min-h-[50px] px-3 py-2" },
                  React.createElement('input', {
                    type: "text",
                    value: emojiString,
                    onChange: (e) => setEmojiString(e.target.value),
                    placeholder: "Select from the grid or type...",
                    className: "w-full p-0 bg-transparent border-none text-2xl tracking-widest text-[var(--color-text-primary)] focus:ring-0 placeholder:text-base placeholder:text-[var(--color-text-tertiary)]",
                    'aria-label': "Recipe Emojis"
                  })
                )
              ),
              React.createElement('div', { className: "p-3 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)] flex flex-wrap gap-2" },
                FOOD_EMOJIS.map(emoji => React.createElement('button', {
                  key: emoji,
                  type: "button",
                  onClick: () => addEmoji(emoji),
                  className: "text-2xl p-2 rounded-md transition-colors duration-200 hover:bg-[var(--color-bg-tertiary)]",
                  'aria-label': `Add ${emoji} emoji`
                }, emoji))
              )
            ),
            React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
                React.createElement('label', { className: "block text-lg font-medium text-[var(--color-text-secondary)] mb-2" }, "Categories"),
                React.createElement('div', { className: "flex flex-col sm:flex-row items-center gap-2 mb-3" },
                    React.createElement('input', {
                        type: "text",
                        value: newCategoryName,
                        onChange: e => setNewCategoryName(e.target.value),
                        placeholder: "e.g., Crust, Filling...",
                        className: "w-full sm:flex-grow p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                    }),
                    React.createElement('button', {
                        type: "button",
                        onClick: handleAddCategory,
                        className: "w-full sm:w-auto bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-3 px-4 rounded-md flex-shrink-0"
                    }, "Add Category")
                ),
                categories.length > 0 && React.createElement('div', { className: "flex flex-wrap gap-2 p-3 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)]" },
                    categories.map(cat => React.createElement('span', { key: cat.id, className: "bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2" },
                        cat.name,
                        React.createElement('button', { type: "button", onClick: () => handleRemoveCategory(cat.id), className: "text-[var(--color-text-tertiary)] hover:text-[var(--color-text-primary)]" },
                            React.createElement(XMarkIcon, { className: "w-3 h-3" })
                        )
                    ))
                )
            ),
            React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
              React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Ingredients"),
              React.createElement('div', { className: "space-y-4" },
                ingredients.map((ing, index) => React.createElement('div', { key: ing.id, className: "grid grid-cols-1 md:grid-cols-[auto_auto_1fr_auto_auto] items-center gap-2 p-3 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)]" },
                  React.createElement('input', {
                    type: "text",
                    value: ing.quantity,
                    onChange: (e) => handleIngredientChange(index, 'quantity', e.target.value),
                    className: "w-full md:w-20 p-2 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)]",
                    placeholder: "Qty"
                  }),
                  React.createElement('select', {
                    value: ing.unit,
                    onChange: (e) => handleIngredientChange(index, 'unit', e.target.value),
                    className: "w-full md:w-32 p-2 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)]"
                  }, 
                    units.map(unit => React.createElement('option', { key: unit.id, value: unit.id }, unit.label)),
                    React.createElement('option', { value: ADD_NEW_UNIT_VALUE, className: "text-blue-400 font-bold" }, 'Add new...')
                  ),
                  React.createElement('input', {
                    type: "text",
                    value: ing.name,
                    onChange: (e) => handleIngredientChange(index, 'name', e.target.value),
                    className: "flex-grow p-2 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)]",
                    placeholder: "Ingredient Name"
                  }),
                   React.createElement('select', {
                    value: ing.categoryId || '',
                    onChange: (e) => handleIngredientChange(index, 'categoryId', e.target.value || undefined),
                    className: `w-full md:w-32 p-2 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] ${!ing.categoryId ? 'text-[var(--color-text-tertiary)]' : ''}`
                  }, 
                    React.createElement('option', { value: '' }, 'Uncategorized'),
                    categories.map(cat => React.createElement('option', { key: cat.id, value: cat.id }, cat.name))
                  ),
                  React.createElement('button', { type: "button", onClick: () => removeIngredient(index), className: "text-red-500 hover:text-red-400 p-2 justify-self-end" },
                    React.createElement(TrashIcon, { className: "w-5 h-5" })
                  )
                ))
              ),
              React.createElement('button', {
                type: "button",
                onClick: addIngredient,
                className: "mt-4 flex items-center text-[var(--color-accent-text)] font-semibold hover:brightness-110"
              }, React.createElement(PlusIcon, { className: "w-5 h-5 mr-2" }), " Add Ingredient")
            ),
            React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
              React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Steps"),
              React.createElement('div', { className: "space-y-4" },
                steps.map((step, index) => React.createElement('div', { key: step.id, className: "flex items-start gap-2" },
                  React.createElement('span', { className: "text-lg font-bold text-[var(--color-text-tertiary)] pt-2" }, `${index + 1}.`),
                   React.createElement('div', { className: "flex-grow flex flex-col gap-2" },
                      React.createElement('textarea', {
                        value: step.text,
                        onChange: (e) => handleStepChange(index, 'text', e.target.value),
                        rows: 3,
                        className: "flex-grow p-2 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] w-full",
                        placeholder: "Describe step..."
                      }),
                      React.createElement('select', {
                        value: step.categoryId || '',
                        onChange: (e) => handleStepChange(index, 'categoryId', e.target.value || undefined),
                        className: `w-full sm:w-40 p-2 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] text-sm ${!step.categoryId ? 'text-[var(--color-text-tertiary)]' : ''}`
                      }, 
                        React.createElement('option', { value: '' }, 'Uncategorized'),
                        categories.map(cat => React.createElement('option', { key: cat.id, value: cat.id }, cat.name))
                      )
                    ),
                  React.createElement('button', { type: "button", onClick: () => removeStep(index), className: "text-red-500 hover:text-red-400 p-2" },
                    React.createElement(TrashIcon, { className: "w-5 h-5" })
                  )
                ))
              ),
               React.createElement('button', {
                type: "button",
                onClick: addStep,
                className: "mt-4 flex items-center text-[var(--color-accent-text)] font-semibold hover:brightness-110"
              }, React.createElement(PlusIcon, { className: "w-5 h-5 mr-2" }), " Add Step")
            ),
            React.createElement('div', { className: "flex justify-end gap-4 mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
              React.createElement('button', { type: "button", onClick: onCancel, className: "bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-6 rounded-md" }, "Cancel"),
              React.createElement('button', { type: "submit", className: "bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-2 px-6 rounded-md" }, initialRecipe ? 'Save Changes' : 'Save Recipe')
            )
          )
        );
      };
      
      // --- Start of inlined components/RecipeDetail.tsx ---
      const RecipeDetail = ({ recipe, onBack, onEdit, onDelete, showConfirmDialog, units, sections, onAddIngredientsToShoppingList }) => {
          const [multiplier, setMultiplier] = useState(1);
          const [justAdded, setJustAdded] = useState(false);
          const [isShareDialogOpen, setIsShareDialogOpen] = useState(false);
          
          const unitMap = useMemo(() => new Map(units.map(u => [u.id, u])), [units]);

          const multipliers = [
              { label: '¬º', value: 0.25 },
              { label: '‚Öì', value: 1/3 },
              { label: '¬Ω', value: 0.5 },
              { label: '1x', value: 1 },
          ];

          const formatQuantity = (quantity) => {
              const result = quantity * multiplier;
              if (result === 0) return '';
              if (result < 0.1) return result.toFixed(3);
              if (result < 1) return result.toFixed(2);
              return Number.isInteger(result) ? result : result.toFixed(2);
          }
          
          const handleDelete = () => {
              showConfirmDialog(
                  'Delete Recipe',
                  `Are you sure you want to delete "${recipe.name}"? This action cannot be undone.`,
                  () => onDelete(recipe.id)
              );
          };

          const handleAddAllToShoppingList = () => {
            if (justAdded) return;
    
            const itemsToAdd = recipe.ingredients.map(ing => {
                const quantityStr = String(ing.quantity);
                const numericQuantity = Number(quantityStr);
                const isNumeric = quantityStr.trim() !== '' && isFinite(numericQuantity);
                
                const quantityDisplay = isNumeric ? formatQuantity(numericQuantity) : ing.quantity;
                const unitLabel = unitMap.get(ing.unit)?.label || ing.unit;
    
                const prefix = (quantityDisplay || unitLabel) 
                    ? `${quantityDisplay} ${unitLabel.toLowerCase()}`.trim() + ' - ' 
                    : '';
                return `${prefix}${ing.name}`;
            });
    
            onAddIngredientsToShoppingList(itemsToAdd);
    
            setJustAdded(true);
            setTimeout(() => {
                setJustAdded(false);
            }, 2000);
          };

          const { groupedIngredients, uncategorizedIngredients } = useMemo(() => {
              const grouped = {};
              const uncategorized = [];
              if (!recipe.ingredients) return { grouped: {}, uncategorized: [] };
              
              recipe.ingredients.forEach(ing => {
                  if (ing.categoryId) {
                      if (!grouped[ing.categoryId]) grouped[ing.categoryId] = [];
                      grouped[ing.categoryId].push(ing);
                  } else {
                      uncategorized.push(ing);
                  }
              });
              return { groupedIngredients: grouped, uncategorizedIngredients: uncategorized };
          }, [recipe.ingredients]);
          
          const { groupedSteps, uncategorizedSteps } = useMemo(() => {
              const grouped = {};
              const uncategorized = [];
              if (!recipe.steps) return { grouped: {}, uncategorized: [] };
              
              recipe.steps.forEach(step => {
                  const stepObj = typeof step === 'string' ? { text: step, categoryId: null } : step;
                  if (stepObj.categoryId) {
                      if (!grouped[stepObj.categoryId]) grouped[stepObj.categoryId] = [];
                      grouped[stepObj.categoryId].push(stepObj.text);
                  } else {
                      uncategorized.push(stepObj.text);
                  }
              });
              return { groupedSteps: grouped, uncategorizedSteps: uncategorized };
          }, [recipe.steps]);

          const renderIngredientItem = (ing) => {
              const isScaling = multiplier !== 1;
              const quantityStr = String(ing.quantity);
              const numericQuantity = Number(quantityStr);
              const isNumeric = quantityStr.trim() !== '' && isFinite(numericQuantity);
              const quantityDisplay = isNumeric ? formatQuantity(numericQuantity) : ing.quantity;
              const quantityColor = (isScaling && !isNumeric && ing.quantity) ? 'text-red-400' : 'text-[var(--color-text-primary)]';
              const unitLabel = unitMap.get(ing.unit)?.label || ing.unit;
              
              return React.createElement('li', { key: ing.id },
                  React.createElement('span', { className: `font-medium ${quantityColor}` }, `${quantityDisplay} ${unitLabel.toLowerCase()}`), ` - ${ing.name}`
              );
          };

          const hasCategories = recipe.categories && recipe.categories.length > 0;

        return React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-8" },
            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                React.createElement('button', { onClick: onBack, className: "flex items-center text-[var(--color-accent-text)] font-semibold hover:brightness-110" },
                    React.createElement(ChevronLeftIcon, { className: "w-5 h-5 mr-1" }),
                    "Back to Recipes"
                ),
                React.createElement('div', { className: "flex items-center gap-2" },
                    React.createElement('button', { 
                        onClick: () => onEdit(recipe.id), 
                        className: "p-2 rounded-full text-[var(--color-text-tertiary)] hover:bg-[var(--color-bg-tertiary)] hover:text-[var(--color-text-primary)] transition-colors",
                        'aria-label': "Edit recipe"
                    }, React.createElement(PencilIcon, { className: "w-6 h-6" })),
                    React.createElement('button', { 
                        onClick: handleDelete, 
                        className: "p-2 rounded-full text-red-500 hover:bg-red-900/50 hover:text-red-400 transition-colors",
                        'aria-label': "Delete recipe"
                    }, React.createElement(TrashIcon, { className: "w-6 h-6" })),
                    React.createElement('button', {
                        onClick: handleAddAllToShoppingList,
                        disabled: justAdded,
                        title: justAdded ? "Added to shopping list" : "Add all ingredients to shopping list",
                        'aria-label': justAdded ? "Added to shopping list" : "Add all ingredients to shopping list",
                        className: `p-2 rounded-full transition-colors ${
                            justAdded
                            ? 'bg-green-600 text-white'
                            : 'text-[var(--color-text-tertiary)] hover:bg-[var(--color-bg-tertiary)] hover:text-[var(--color-text-primary)]'
                        }`
                    }, React.createElement(ShoppingBagIcon, { className: "w-6 h-6" })),
                    React.createElement('button', { 
                        onClick: () => setIsShareDialogOpen(true), 
                        className: "p-2 rounded-full text-[var(--color-text-tertiary)] hover:bg-[var(--color-bg-tertiary)] hover:text-[var(--color-text-primary)] transition-colors",
                        'aria-label': "Share recipe",
                        style: { display: navigator.share ? 'block' : 'none' }
                    }, React.createElement(ArrowUpTrayIcon, { className: "w-6 h-6" }))
                )
            ),
            React.createElement('div', { className: "bg-[var(--color-bg-secondary)] p-8 rounded-lg shadow-lg border border-[var(--color-border-primary)]" },
                React.createElement('div', { className: "flex justify-between items-start gap-4 mb-4 pb-4" },
                    React.createElement('div', { className: "flex items-center gap-3 flex-grow" },
                        recipe.emojis && recipe.emojis.length > 0 && (
                            React.createElement('span', { className: "text-4xl", 'aria-hidden': "true" }, recipe.emojis.join(''))
                        ),
                        React.createElement('h1', { className: "text-4xl font-bold text-[var(--color-text-primary)]" }, recipe.name)
                    )
                ),
                recipe.description && (
                  React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
                    React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Notes"),
                    React.createElement('p', { className: "text-[var(--color-text-secondary)] whitespace-pre-wrap" }, recipe.description)
                  )
                ),
                React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
                    React.createElement('div', { className: "flex justify-between items-center mb-4" },
                        React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)]" }, "Ingredients"),
                        React.createElement('div', { className: "flex gap-2" },
                            multipliers.map(m => (
                                 React.createElement('button', { 
                                    key: m.label, 
                                    onClick: () => setMultiplier(m.value),
                                    className: `px-3 py-1 text-sm font-semibold rounded-full transition-colors ${multiplier === m.value ? 'bg-[var(--color-accent)] text-white' : 'bg-[var(--color-bg-secondary)] text-[var(--color-text-secondary)] hover:bg-[var(--color-bg-tertiary)]'}`
                                }, m.label)
                            ))
                        )
                    ),
                    hasCategories ?
                        React.createElement('div', { className: "space-y-4" },
                            recipe.categories.map(category => {
                                const ingredientsForCategory = groupedIngredients[category.id];
                                if (!ingredientsForCategory || ingredientsForCategory.length === 0) return null;
                                return React.createElement('div', { key: category.id },
                                    React.createElement('h3', { className: "text-lg font-bold text-[var(--color-accent-text)] mb-2 border-b border-[var(--color-border-primary)] pb-1" }, category.name),
                                    React.createElement('ul', { className: "list-disc list-inside space-y-2 text-[var(--color-text-secondary)] pl-2" }, ingredientsForCategory.map(renderIngredientItem))
                                )
                            }),
                            uncategorizedIngredients.length > 0 && React.createElement('div', { className: "pt-4" },
                                React.createElement('ul', { className: "list-disc list-inside space-y-2 text-[var(--color-text-secondary)]" }, uncategorizedIngredients.map(renderIngredientItem))
                            )
                        ) :
                        React.createElement('ul', { className: "list-disc list-inside space-y-2 text-[var(--color-text-secondary)]" }, recipe.ingredients.map(renderIngredientItem))
                ),
                React.createElement('div', { className: "mt-8 pt-4 border-t border-[var(--color-border-primary)]" },
                    React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Steps"),
                     hasCategories ? 
                        React.createElement('div', { className: "space-y-6" },
                            recipe.categories.map(category => {
                                const stepsForCategory = groupedSteps[category.id];
                                if (!stepsForCategory || stepsForCategory.length === 0) return null;
                                return React.createElement('div', { key: category.id },
                                    React.createElement('h3', { className: "text-lg font-bold text-[var(--color-accent-text)] mb-2 border-b border-[var(--color-border-primary)] pb-1" }, category.name),
                                    React.createElement('ol', { className: "list-decimal list-inside space-y-4 text-[var(--color-text-secondary)]" }, 
                                        stepsForCategory.map((step, index) => React.createElement('li', { key: index, className: "pl-2" }, step))
                                    )
                                )
                            }),
                            uncategorizedSteps.length > 0 && React.createElement('div', { className: "pt-4" },
                                React.createElement('ol', { className: "list-decimal list-inside space-y-4 text-[var(--color-text-secondary)]" }, 
                                    uncategorizedSteps.map((step, index) => React.createElement('li', { key: index, className: "pl-2" }, step))
                                )
                            )
                        ) :
                        React.createElement('ol', { className: "list-decimal list-inside space-y-4 text-[var(--color-text-secondary)]" },
                           uncategorizedSteps.map((step, index) => (
                                React.createElement('li', { key: index, className: "pl-2" }, step)
                            ))
                        )
                )
            ),
            React.createElement(ShareDialog, {
                isOpen: isShareDialogOpen,
                onClose: () => setIsShareDialogOpen(false),
                recipe: recipe,
                allSections: sections,
                allUnits: units
            })
        );
      };

      // --- Start of inlined components/RecipeList.tsx ---
      const RecipeCard = ({ recipe, onSelect }) => {
        const emojis = recipe.emojis || [];
        const numEmojis = emojis.length;

        const gridCols = numEmojis > 1 ? Math.ceil(Math.sqrt(numEmojis)) : 1;

        let emojiSizeClass = 'text-3xl';
        if (gridCols === 3) {
            emojiSizeClass = 'text-2xl';
        } else if (gridCols === 4) {
            emojiSizeClass = 'text-lg';
        } else if (gridCols >= 5) {
            emojiSizeClass = 'text-base';
        }

        return React.createElement('div', {
          onClick: () => onSelect(recipe.id),
          className: "bg-[var(--color-bg-secondary)] rounded-lg shadow-md hover:shadow-xl hover:bg-[var(--color-bg-tertiary)] transition-all duration-200 cursor-pointer border border-[var(--color-border-primary)] flex overflow-hidden min-h-[88px]"
        },
          numEmojis > 0 && React.createElement('div', {
            className: "flex-shrink-0 w-20 flex items-center justify-center p-2 border-r border-[var(--color-border-primary)]"
          },
            React.createElement('div', {
                className: "grid place-items-center gap-0.5",
                style: { gridTemplateColumns: `repeat(${gridCols}, minmax(0, 1fr))` },
                'aria-hidden': "true"
            }, emojis.map((emoji, index) =>
                React.createElement('span', {
                    key: index,
                    className: `${emojiSizeClass} leading-tight`
                }, emoji)
            ))
          ),
          React.createElement('div', {
            className: "p-4 flex-grow min-w-0 flex flex-col justify-center"
          },
            React.createElement('h2', {
              className: "text-xl font-semibold text-[var(--color-text-primary)] truncate"
            }, recipe.name),
            recipe.description && React.createElement('p', {
              className: "mt-2 text-[var(--color-text-tertiary)] text-sm truncate"
            }, recipe.description)
          )
        );
      };

      const RecipeList = ({ recipes, sections, onSelectRecipe, onAddRecipe, onExport, onFileSelect, onGoToSettings, onGoToShoppingList, onGoToTimers, ownerName }) => {
        const [searchTerm, setSearchTerm] = useState('');
        const [openSections, setOpenSections] = useState({});
        const importInputRef = useRef(null);
        const [isSearchVisible, setIsSearchVisible] = useState(false);
        const searchInputRef = useRef(null);

        useEffect(() => {
            if (isSearchVisible) {
                searchInputRef.current?.focus();
            }
        }, [isSearchVisible]);

        const handleImportClick = () => {
          importInputRef.current?.click();
        };

        const filteredRecipes = useMemo(() => {
          const term = searchTerm.toLowerCase().trim();
          if (!term) return recipes;
          return recipes.filter(recipe =>
            recipe.name.toLowerCase().includes(term) ||
            (recipe.description && recipe.description.toLowerCase().includes(term)) ||
            (recipe.emojis && recipe.emojis.join('').includes(term)) ||
            recipe.ingredients.some(ing => ing.name.toLowerCase().includes(term)) ||
            (Array.isArray(recipe.steps) && recipe.steps.some(step => (typeof step === 'string' ? step : step.text).toLowerCase().includes(term)))
          );
        }, [searchTerm, recipes]);
        
        const { recipesBySection, uncategorizedRecipes } = useMemo(() => {
            const sectionMap = new Map(sections.map(s => [s.id, s]));
            const bySection = {};
            const uncategorized = [];

            for (const recipe of filteredRecipes) {
                let isCategorized = false;
                const targetSectionIds = recipe.sectionIds || (recipe.sectionId ? [recipe.sectionId] : []);
                
                if (targetSectionIds.length > 0) {
                    for (const sectionId of targetSectionIds) {
                        if (sectionMap.has(sectionId)) {
                            if (!bySection[sectionId]) bySection[sectionId] = [];
                            bySection[sectionId].push(recipe);
                            isCategorized = true;
                        }
                    }
                }

                if (!isCategorized) {
                    uncategorized.push(recipe);
                }
            }
            return { recipesBySection: bySection, uncategorizedRecipes: uncategorized };
        }, [filteredRecipes, sections]);

        useEffect(() => {
          if (searchTerm.trim()) {
            const newOpenSections = {};
            Object.keys(recipesBySection).forEach(sectionId => {
              newOpenSections[sectionId] = true;
            });
            setOpenSections(newOpenSections);
          }
        }, [searchTerm, recipesBySection]);

        const toggleSection = (sectionId) => {
          setOpenSections(prev => ({ ...prev, [sectionId]: !prev[sectionId] }));
        };
        
        return (
          React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-8" },
            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                React.createElement('div', { className: "flex items-center gap-2", style: { flex: '1 1 0%' } },
                    React.createElement('button', {
                        onClick: onGoToSettings,
                        className: "p-2 rounded-full text-[var(--color-text-tertiary)] hover:bg-[var(--color-bg-tertiary)] hover:text-[var(--color-text-primary)] transition-colors",
                        'aria-label': "Settings"
                    }, React.createElement(BurgerMenuIcon, { className: "w-7 h-7" })),
                    React.createElement('button', {
                        onClick: onGoToShoppingList,
                        className: "p-2 rounded-full text-[var(--color-text-tertiary)] hover:bg-[var(--color-bg-tertiary)] hover:text-[var(--color-text-primary)] transition-colors",
                        'aria-label': "Shopping List"
                    }, React.createElement(ShoppingBagIcon, { className: "w-7 h-7" }))
                ),
                React.createElement('h1', { className: "font-fancy text-4xl sm:text-5xl font-bold text-[var(--color-accent-text)] text-center px-2 flex-shrink min-w-0" }, `${ownerName}'s recipes`),
                React.createElement('div', { className: "flex items-center gap-2 justify-end", style: { flex: '1 1 0%' } },
                    React.createElement('button', {
                        onClick: onGoToTimers,
                        className: "p-2 rounded-full text-[var(--color-text-tertiary)] hover:bg-[var(--color-bg-tertiary)] hover:text-[var(--color-text-primary)] transition-colors",
                        'aria-label': "Timers"
                    }, React.createElement(ClockIcon, { className: "w-7 h-7" })),
                    React.createElement('button', {
                        onClick: () => setIsSearchVisible(prev => !prev),
                        className: "p-2 rounded-full text-[var(--color-text-tertiary)] hover:bg-[var(--color-bg-tertiary)] hover:text-[var(--color-text-primary)] transition-colors",
                        'aria-label': "Toggle Search"
                    }, React.createElement(SearchIcon, { className: "w-7 h-7" }))
                )
            ),
            React.createElement('div', { className: "flex flex-col sm:flex-row justify-end items-center gap-4 mb-8" },
              React.createElement('div', {
                className: `relative sm:flex-grow w-full sm:w-auto transition-all duration-300 ease-in-out ${isSearchVisible ? 'max-w-full sm:max-w-md' : 'max-w-0 opacity-0'}`
              },
                React.createElement(SearchIcon, { className: "absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--color-text-tertiary)] pointer-events-none" }),
                React.createElement('input', {
                  ref: searchInputRef,
                  type: "text",
                  placeholder: "Search recipes...",
                  value: searchTerm,
                  onChange: e => setSearchTerm(e.target.value),
                  className: "w-full bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-full py-2 pl-10 pr-4 text-[var(--color-text-primary)] focus:ring-2 focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                })
              ),
              React.createElement('button', {
                onClick: onAddRecipe,
                className: "bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-2 px-4 rounded-full flex items-center shadow-lg transition-transform transform hover:scale-105 w-full sm:w-auto justify-center flex-shrink-0",
                'aria-label': "Add a new recipe"
              },
                React.createElement(PlusIcon, { className: "w-5 h-5 mr-2" }),
                "Add Recipe"
              )
            ),
            
            filteredRecipes.length === 0 ? (
              React.createElement('div', { className: "text-center bg-[var(--color-bg-secondary)] p-12 rounded-lg border-2 border-dashed border-[var(--color-border-primary)]" },
                  React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)]" }, searchTerm ? 'No Recipes Found' : 'No Recipes Yet!'),
                  React.createElement('p', { className: "text-[var(--color-text-tertiary)] mt-2" }, searchTerm ? `Your search for "${searchTerm}" did not match any recipes.` : 'Click "Add Recipe" to get started.')
              )
            ) : (
              React.createElement('div', { className: "space-y-4" },
                sections.map(section => {
                  const sectionRecipes = recipesBySection[section.id];
                  if (!sectionRecipes || sectionRecipes.length === 0) return null;

                  return (
                    React.createElement('div', { key: section.id, className: "bg-[var(--color-bg-secondary)]/50 rounded-lg border border-[var(--color-border-primary)] overflow-hidden" },
                      React.createElement('button', {
                        onClick: () => toggleSection(section.id),
                        className: "w-full flex justify-between items-center p-4 text-left font-semibold text-xl text-[var(--color-accent-text)] hover:bg-[var(--color-bg-tertiary)]/50"
                      },
                        React.createElement('span', null, 
                            `${section.name} `,
                            React.createElement('span', { className: "text-sm font-normal text-[var(--color-text-tertiary)]" }, `(${sectionRecipes.length})`)
                        ),
                        React.createElement(ChevronDownIcon, { className: `w-5 h-5 transition-transform ${openSections[section.id] ? 'rotate-180' : ''}` })
                      ),
                      openSections[section.id] && (
                        React.createElement('div', { className: "p-4 space-y-3" },
                          sectionRecipes.map(recipe => React.createElement(RecipeCard, { key: recipe.id, recipe: recipe, onSelect: onSelectRecipe }))
                        )
                      )
                    )
                  );
                }),
                
                uncategorizedRecipes.length > 0 && (
                  React.createElement('div', { className: "space-y-3 pt-4" },
                    uncategorizedRecipes.map(recipe => React.createElement(RecipeCard, { key: recipe.id, recipe: recipe, onSelect: onSelectRecipe }))
                  )
                )
              )
            ),

            React.createElement('div', { className: "mt-12 pt-8 border-t border-[var(--color-border-primary)] flex flex-col sm:flex-row justify-center items-center gap-4" },
              React.createElement('input', { 
                  type: "file", 
                  ref: importInputRef, 
                  onChange: onFileSelect,
                  className: "hidden",
                  accept: ".json"
              }),
              React.createElement('button', { 
                  onClick: handleImportClick,
                  className: "bg-[var(--color-bg-tertiary)] hover:brightness-110 text-[var(--color-text-secondary)] font-bold py-2 px-4 rounded-full flex items-center shadow-lg transition-transform transform hover:scale-105 w-full sm:w-auto justify-center"
              },
                  React.createElement(CloudUploadIcon, { className: "w-5 h-5 mr-2" }),
                  "Import"
              ),
              React.createElement('button', {
                  onClick: onExport,
                  className: "bg-[var(--color-bg-tertiary)] hover:brightness-110 text-[var(--color-text-secondary)] font-bold py-2 px-4 rounded-full flex items-center shadow-lg transition-transform transform hover:scale-105 w-full sm:w-auto justify-center"
              },
                  React.createElement(CloudDownloadIcon, { className: "w-5 h-5 mr-2" }),
                  "Export"
              )
            )
          )
        );
      };
      
      // --- Start of inlined components/Settings.tsx ---
      const Settings = ({ textSize, setTextSize, units, onAddUnit, onDeleteUnit, onBack, showConfirmDialog, sections, recipes, onAddSection, onDeleteSection, ownerName, setOwnerName }) => {
        const [newUnitLabel, setNewUnitLabel] = useState('');
        const [newSectionName, setNewSectionName] = useState('');

        const MIN_TEXT_SIZE = 0.5;
        const MAX_TEXT_SIZE = 1.25;
        const STEP_TEXT_SIZE = 0.05;

        const handleTextSizeChange = (newSize) => {
            // Round to avoid floating point inaccuracies with the step
            const roundedSize = Math.round(newSize / STEP_TEXT_SIZE) * STEP_TEXT_SIZE;
            const clampedSize = Math.max(MIN_TEXT_SIZE, Math.min(MAX_TEXT_SIZE, roundedSize));
            setTextSize(clampedSize);
        };

        const sectionUsageCount = useMemo(() => {
          const counts = {};
          sections.forEach(s => counts[s.id] = 0);
          recipes.forEach(recipe => {
            const recipeSections = recipe.sectionIds || (recipe.sectionId ? [recipe.sectionId] : []);
            recipeSections.forEach(sectionId => {
              if (counts.hasOwnProperty(sectionId)) {
                counts[sectionId]++;
              }
            });
          });
          return counts;
        }, [recipes, sections]);

        const handleAddUnit = () => {
          const trimmed = newUnitLabel.trim();
          if (trimmed) {
            onAddUnit(trimmed);
            setNewUnitLabel('');
          }
        };

        const handleDeleteUnit = (unit) => {
          showConfirmDialog(
            'Delete Unit',
            `Are you sure you want to delete "${unit.label}"? This cannot be undone.`,
            () => onDeleteUnit(unit.id)
          );
        };
        
        const handleAddSection = () => {
          const trimmed = newSectionName.trim();
          if (trimmed) {
            onAddSection(trimmed);
            setNewSectionName('');
          }
        };

        const handleDeleteSection = (section) => {
          showConfirmDialog(
            'Delete Section',
            `Are you sure you want to delete the section "${section.name}"?`,
            () => onDeleteSection(section.id)
          );
        };

        return React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-8" },
          React.createElement('button', { onClick: onBack, className: "flex items-center text-[var(--color-accent-text)] font-semibold hover:brightness-110 mb-6" },
              React.createElement(ChevronLeftIcon, { className: "w-5 h-5 mr-1" }),
              "Back to Recipes"
          ),
          React.createElement('div', { className: "bg-[var(--color-bg-secondary)] p-8 rounded-lg shadow-lg border border-[var(--color-border-primary)]" },
              React.createElement('h1', { className: "text-4xl font-bold text-[var(--color-text-primary)] mb-8" }, "Settings"),
              React.createElement('div', { className: "" },
                  React.createElement('div', null,
                      React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Personalization"),
                      React.createElement('div', { className: "p-3 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)]" },
                          React.createElement('label', { htmlFor: "owner-name", className: "block font-medium text-[var(--color-text-primary)] mb-2" }, "Whose recipes are these?"),
                          React.createElement('input', {
                              id: "owner-name",
                              type: "text",
                              value: ownerName,
                              onChange: e => setOwnerName(e.target.value),
                              placeholder: "e.g., Sharn√©",
                              className: "w-full p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                          })
                      )
                  ),
                  React.createElement('div', { className: "pt-8 mt-8 border-t border-[var(--color-border-primary)]" },
                      React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Appearance"),
                      React.createElement('div', { className: "space-y-4" },
                          React.createElement('div', { className: "p-3 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)]" },
                              React.createElement('label', { className: "block font-medium text-[var(--color-text-primary)] mb-3" }, `Text Size: ${Math.round(textSize * 100)}%`),
                              React.createElement('div', { className: "flex items-center gap-3" },
                                  React.createElement('button', {
                                      type: 'button',
                                      onClick: () => handleTextSizeChange(textSize - STEP_TEXT_SIZE),
                                      className: "p-2 rounded-full bg-[var(--color-bg-tertiary)] hover:bg-[var(--color-border-primary)] disabled:opacity-50 disabled:cursor-not-allowed transition-colors",
                                      disabled: textSize <= MIN_TEXT_SIZE,
                                      'aria-label': "Decrease text size"
                                  }, React.createElement(MinusIcon, { className: "w-5 h-5" })),
                                  React.createElement('input', {
                                      type: 'range',
                                      min: MIN_TEXT_SIZE,
                                      max: MAX_TEXT_SIZE,
                                      step: STEP_TEXT_SIZE,
                                      value: textSize,
                                      className: "w-full h-2 bg-[var(--color-bg-tertiary)] rounded-lg appearance-none pointer-events-none accent-[var(--color-accent)]",
                                      'aria-label': "Text size slider"
                                  }),
                                  React.createElement('button', {
                                      type: 'button',
                                      onClick: () => handleTextSizeChange(textSize + STEP_TEXT_SIZE),
                                      className: "p-2 rounded-full bg-[var(--color-bg-tertiary)] hover:bg-[var(--color-border-primary)] disabled:opacity-50 disabled:cursor-not-allowed transition-colors",
                                      disabled: textSize >= MAX_TEXT_SIZE,
                                      'aria-label': "Increase text size"
                                  }, React.createElement(PlusIcon, { className: "w-5 h-5" }))
                              )
                          )
                      )
                  ),
                  React.createElement('div', { className: "pt-8 mt-8 border-t border-[var(--color-border-primary)]" },
                      React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Recipe Sections"),
                      React.createElement('div', { className: "flex flex-col sm:flex-row items-center gap-2 mb-4" },
                          React.createElement('input', {
                              type: "text",
                              value: newSectionName,
                              onChange: e => setNewSectionName(e.target.value),
                              placeholder: "New section name",
                              className: "w-full sm:flex-grow p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                          }),
                          React.createElement('button', {
                              type: "button",
                              onClick: handleAddSection,
                              className: "w-full sm:w-auto bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-3 px-4 rounded-md flex-shrink-0"
                          }, "Add Section")
                      ),
                      React.createElement('div', { className: "space-y-2 p-4 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)] max-h-96 overflow-y-auto" },
                          sections.length > 0 ? sections.map(section => {
                              const inUseCount = sectionUsageCount[section.id] || 0;
                              const isInUse = inUseCount > 0;
                              return React.createElement('div', { key: section.id, className: "flex justify-between items-center p-2 rounded-md hover:bg-[var(--color-bg-tertiary)]" },
                                  React.createElement('span', { className: "text-[var(--color-text-primary)]" }, 
                                      section.name,
                                      isInUse && React.createElement('span', { className: "text-xs text-[var(--color-text-tertiary)] ml-2" }, `(${inUseCount} recipes)`)
                                  ),
                                  React.createElement('button', {
                                      onClick: () => handleDeleteSection(section),
                                      disabled: isInUse,
                                      className: "p-1 disabled:text-gray-600 disabled:cursor-not-allowed text-red-500 hover:text-red-400",
                                      title: isInUse ? "Cannot delete a section that is in use." : "Delete section"
                                  }, React.createElement(TrashIcon, { className: "w-5 h-5" }))
                              )
                          }) : React.createElement('p', { className: "text-[var(--color-text-tertiary)] text-center" }, "No sections created.")
                      )
                  ),
                  React.createElement('div', { className: "pt-8 mt-8 border-t border-[var(--color-border-primary)]" },
                      React.createElement('h2', { className: "text-2xl font-semibold text-[var(--color-text-secondary)] mb-4" }, "Measurement Units"),
                      React.createElement('div', { className: "flex flex-col sm:flex-row items-center gap-2 mb-4" },
                          React.createElement('input', {
                              type: "text",
                              value: newUnitLabel,
                              onChange: e => setNewUnitLabel(e.target.value),
                              placeholder: "New unit name (e.g. Pinch)",
                              className: "w-full sm:flex-grow p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                          }),
                          React.createElement('button', {
                              type: "button",
                              onClick: handleAddUnit,
                              className: "w-full sm:w-auto bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-3 px-4 rounded-md flex-shrink-0"
                          }, "Add Unit")
                      ),
                      React.createElement('div', { className: "space-y-2 p-4 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)] max-h-96 overflow-y-auto" },
                          units.length > 0 ? units.map(unit =>
                              React.createElement('div', { key: unit.id, className: "flex justify-between items-center p-2 rounded-md hover:bg-[var(--color-bg-tertiary)]" },
                                  React.createElement('span', { className: "text-[var(--color-text-primary)]" }, unit.label),
                                  React.createElement('button', {
                                      onClick: () => handleDeleteUnit(unit),
                                      className: "text-red-500 hover:text-red-400 p-1"
                                  }, React.createElement(TrashIcon, { className: "w-5 h-5" }))
                              )
                          ) : React.createElement('p', { className: "text-[var(--color-text-tertiary)] text-center" }, "No units defined.")
                      )
                  )
              )
          )
        );
      };
      
      // --- Start of inlined components/Timers.tsx ---
      const Timers = ({ onBack, showConfirmDialog }) => {
        const DEFAULT_TIMER = {
            id: Date.now(),
            name: 'Default',
            duration: { hours: 0, minutes: 0, seconds: 0 },
            remainingTime: 0,
            isRunning: false,
            isFinished: false,
        };
        const [timers, setTimers] = useLocalStorage('timers', [DEFAULT_TIMER]);
        const audioRef = useRef(null);

        useEffect(() => {
            const interval = setInterval(() => {
                setTimers(prev =>
                    prev.map(t => {
                        if (!t.isRunning || t.remainingTime <= 0) {
                            return t;
                        }
                        const newRemainingTime = t.remainingTime - 1;
                        if (newRemainingTime <= 0) {
                            if (audioRef.current) {
                                audioRef.current.play().catch(e => console.error("Audio play failed:", e));
                            }
                            return { ...t, remainingTime: 0, isRunning: false, isFinished: true };
                        }
                        return { ...t, remainingTime: newRemainingTime };
                    })
                );
            }, 1000);
            return () => clearInterval(interval);
        }, []);

        const formatTime = (totalSeconds) => {
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        };

        const handleAddTimer = () => {
            setTimers(prev => [...prev, { ...DEFAULT_TIMER, id: Date.now(), name: `Timer ${prev.length + 1}` }]);
        };

        const handleDeleteTimer = (id) => {
            const timerToDelete = timers.find(t => t.id === id);
            showConfirmDialog(
                'Delete Timer',
                `Are you sure you want to delete the timer "${timerToDelete.name}"?`,
                () => setTimers(prev => prev.filter(t => t.id !== id))
            );
        };
        
        const handleUpdate = (id, field, value) => {
            setTimers(prev => prev.map(t => t.id === id ? { ...t, [field]: value } : t));
        };

        const handleDurationChange = (id, unit, value) => {
            let numericValue = parseInt(value, 10);
            if (isNaN(numericValue) || numericValue < 0) {
                numericValue = 0;
            }

            if (unit === 'minutes' || unit === 'seconds') {
                if (numericValue > 59) numericValue = 59;
            } else if (unit === 'hours') {
                if (numericValue > 99) numericValue = 99;
            }

            setTimers(prev => prev.map(t => {
                if (t.id === id) {
                    const newDuration = { ...t.duration, [unit]: numericValue };
                    return { ...t, duration: newDuration, isFinished: false };
                }
                return t;
            }));
        };
        
        const handleDurationIncrement = (id, unit, delta) => {
            setTimers(prev => prev.map(t => {
                if (t.id === id) {
                    let currentValue = t.duration[unit];
                    let newValue = currentValue + delta;
                    const max = unit === 'hours' ? 99 : 59;
                    const min = 0;
                    if (newValue > max) newValue = max;
                    if (newValue < min) newValue = min;
                    const newDuration = { ...t.duration, [unit]: newValue };
                    return { ...t, duration: newDuration, isFinished: false };
                }
                return t;
            }));
        };

        const handleToggleTimer = (id) => {
            setTimers(prev => prev.map(t => {
                if (t.id === id) {
                    if (t.isRunning) {
                        return { ...t, isRunning: false };
                    }
                    const newRemainingTime = (t.duration.hours * 3600) + (t.duration.minutes * 60) + t.duration.seconds;
                    if (newRemainingTime <= 0) {
                        return t;
                    }
                    return { ...t, isRunning: true, remainingTime: newRemainingTime, isFinished: false };
                }
                return t;
            }));
        };

        const handleResetTimer = (id) => {
            setTimers(prev => prev.map(t => {
                if (t.id === id) {
                    return { ...t, isRunning: false, remainingTime: 0, isFinished: false };
                }
                return t;
            }));
        };

        return React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-8" },
            React.createElement('audio', { ref: audioRef, src: "https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg", preload: "auto" }),
            React.createElement('button', { onClick: onBack, className: "flex items-center text-[var(--color-accent-text)] font-semibold hover:brightness-110 mb-6" },
                React.createElement(ChevronLeftIcon, { className: "w-5 h-5 mr-1" }),
                "Back to Recipes"
            ),
            React.createElement('div', { className: "bg-[var(--color-bg-secondary)] p-8 rounded-lg shadow-lg border border-[var(--color-border-primary)]" },
                React.createElement('h1', { className: "text-4xl font-bold text-[var(--color-text-primary)] mb-8" }, "Timers"),
                React.createElement('div', { className: "space-y-6" },
                    timers.map(timer => {
                        const isFinished = timer.isFinished && !timer.isRunning;
                        const cardBg = isFinished ? 'bg-green-500/10' : 'bg-[var(--color-bg-primary)]';
                        const cardBorder = isFinished ? 'border-green-500' : 'border-[var(--color-border-secondary)]';

                        return React.createElement('div', { key: timer.id, className: `p-4 rounded-lg border ${cardBorder} ${cardBg} transition-colors` },
                            React.createElement('div', { className: "flex justify-between items-center mb-4" },
                                React.createElement('input', {
                                    type: "text",
                                    value: timer.name,
                                    onChange: (e) => handleUpdate(timer.id, 'name', e.target.value),
                                    placeholder: "Timer Name",
                                    className: "flex-grow p-2 bg-transparent border-none text-xl font-semibold text-[var(--color-text-primary)] focus:ring-0",
                                    disabled: timer.isRunning
                                }),
                                React.createElement('button', { onClick: () => handleDeleteTimer(timer.id), className: "text-red-500 hover:text-red-400 p-1" },
                                    React.createElement(TrashIcon, { className: "w-5 h-5" })
                                )
                            ),
                            React.createElement('div', { className: "flex items-center justify-center text-center my-4" },
                                timer.isRunning || (timer.remainingTime > 0 && !timer.isRunning && !isFinished) ? (
                                    React.createElement('div', { className: `text-6xl font-mono tracking-wider ${isFinished ? 'text-green-400' : 'text-[var(--color-text-primary)]'}` },
                                        formatTime(timer.remainingTime)
                                    )
                                ) : (
                                    React.createElement('div', { className: "flex items-center justify-center gap-2 flex-wrap" },
                                        ['hours', 'minutes', 'seconds'].map((unit, index) =>
                                            React.createElement(React.Fragment, { key: unit },
                                                index > 0 && React.createElement('span', { className: "text-3xl font-bold text-[var(--color-text-tertiary)]" }, ':'),
                                                React.createElement('div', { className: "flex items-center" },
                                                    React.createElement('input', {
                                                        type: "number",
                                                        min: "0",
                                                        max: unit === 'hours' ? 99 : 59,
                                                        value: timer.duration[unit],
                                                        onChange: (e) => handleDurationChange(timer.id, unit, e.target.value),
                                                        className: "w-24 p-2 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-4xl text-center text-[var(--color-text-primary)] [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none",
                                                        'aria-label': unit
                                                    }),
                                                    React.createElement('div', { className: "flex flex-col ml-2" },
                                                        React.createElement('button', {
                                                            type: "button",
                                                            onClick: () => handleDurationIncrement(timer.id, unit, 1),
                                                            className: "p-1 rounded-md bg-[var(--color-bg-tertiary)] hover:bg-[var(--color-border-primary)] text-[var(--color-text-secondary)]",
                                                            'aria-label': `Increase ${unit}`
                                                        }, React.createElement(ChevronUpIcon, { className: "w-5 h-5" })),
                                                        React.createElement('button', {
                                                            type: "button",
                                                            onClick: () => handleDurationIncrement(timer.id, unit, -1),
                                                            className: "p-1 mt-1 rounded-md bg-[var(--color-bg-tertiary)] hover:bg-[var(--color-border-primary)] text-[var(--color-text-secondary)]",
                                                            'aria-label': `Decrease ${unit}`
                                                        }, React.createElement(ChevronDownIcon, { className: "w-5 h-5" }))
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            ),
                            isFinished && React.createElement('div', { className: "text-center text-green-400 font-bold mb-4" }, "Timer Finished!"),
                            React.createElement('div', { className: "flex justify-center gap-4" },
                                React.createElement('button', {
                                    onClick: () => handleToggleTimer(timer.id),
                                    className: `px-6 py-2 rounded-md font-semibold text-white ${timer.isRunning ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-[var(--color-accent)] hover:brightness-95'}`
                                }, timer.isRunning ? 'Pause' : 'Start'),
                                React.createElement('button', {
                                    onClick: () => handleResetTimer(timer.id),
                                    className: "px-6 py-2 rounded-md font-semibold bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] hover:brightness-110"
                                }, "Reset")
                            )
                        );
                    })
                ),
                React.createElement('div', { className: "mt-8 pt-6 border-t border-[var(--color-border-primary)]" },
                    React.createElement('button', {
                        onClick: handleAddTimer,
                        className: "w-full flex items-center justify-center gap-2 bg-[var(--color-bg-tertiary)] hover:brightness-110 text-[var(--color-text-secondary)] font-bold py-3 px-4 rounded-md"
                    }, React.createElement(PlusIcon, { className: "w-5 h-5" }), "Add Timer")
                )
            )
        );
      };

       // --- Start of inlined components/ShoppingList.tsx ---
      const ShoppingList = ({ items, onAddItem, onToggleItem, onDeleteItem, onBack, onClearAll, showConfirmDialog }) => {
        const [newItemText, setNewItemText] = useState('');

        const handleAdd = (e) => {
            e.preventDefault();
            const trimmed = newItemText.trim();
            if (trimmed) {
                onAddItem(trimmed);
                setNewItemText('');
            }
        };
        
        const handleDeleteItemWithConfirm = (item) => {
            showConfirmDialog(
                'Delete Item',
                `Are you sure you want to delete "${item.text}"?`,
                () => onDeleteItem(item.id)
            );
        };

        const handleClearAllWithConfirm = () => {
            showConfirmDialog(
                'Clear Shopping List',
                'Are you sure you want to remove all items from the list?',
                onClearAll
            );
        };

        return React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-8" },
          React.createElement('button', { onClick: onBack, className: "flex items-center text-[var(--color-accent-text)] font-semibold hover:brightness-110 mb-6" },
              React.createElement(ChevronLeftIcon, { className: "w-5 h-5 mr-1" }),
              "Back to Recipes"
          ),
          React.createElement('div', { className: "bg-[var(--color-bg-secondary)] p-8 rounded-lg shadow-lg border border-[var(--color-border-primary)]" },
              React.createElement('h1', { className: "text-4xl font-bold text-[var(--color-text-primary)] mb-8" }, "Shopping List"),
              React.createElement('form', { onSubmit: handleAdd, className: "flex flex-col sm:flex-row items-center gap-2 mb-6" },
                  React.createElement('input', {
                      type: "text",
                      value: newItemText,
                      onChange: e => setNewItemText(e.target.value),
                      placeholder: "e.g., Flour, sugar...",
                      className: "w-full sm:flex-grow p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                  }),
                  React.createElement('button', {
                      type: "submit",
                      className: "w-full sm:w-auto bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-3 px-4 rounded-md flex-shrink-0"
                  }, "Add Item")
              ),
              React.createElement('div', { className: "space-y-3 p-4 bg-[var(--color-bg-primary)] rounded-md border border-[var(--color-border-primary)] max-h-[60vh] overflow-y-auto" },
                  items.length > 0 ? items.map(item =>
                      React.createElement('div', { key: item.id, className: "flex items-center justify-between p-3 rounded-md hover:bg-[var(--color-bg-tertiary)]" },
                          React.createElement('label', { className: "flex items-center cursor-pointer flex-grow" },
                              React.createElement('input', {
                                  type: 'checkbox',
                                  checked: item.completed,
                                  onChange: () => onToggleItem(item.id),
                                  className: "w-6 h-6 rounded bg-[var(--color-bg-tertiary)] border-[var(--color-border-secondary)] text-[var(--color-accent)] focus:ring-[var(--color-accent)]"
                              }),
                              React.createElement('span', { className: `ml-4 text-lg ${item.completed ? 'line-through text-[var(--color-text-tertiary)]' : 'text-[var(--color-text-primary)]'}` }, item.text)
                          ),
                          React.createElement('button', {
                              onClick: () => handleDeleteItemWithConfirm(item),
                              className: "text-red-500 hover:text-red-400 p-1 ml-4"
                          }, React.createElement(TrashIcon, { className: "w-5 h-5" }))
                      )
                  ) : React.createElement('p', { className: "text-[var(--color-text-tertiary)] text-center py-4" }, "Your shopping list is empty.")
              ),
              items.length > 0 && React.createElement('div', { className: "mt-6 flex justify-end" },
                  React.createElement('button', {
                      type: "button",
                      onClick: handleClearAllWithConfirm,
                      className: "bg-red-700 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition-colors"
                  }, "Clear All")
              )
          )
        );
      };

      // --- Start of inlined App.tsx ---
      const ShareDialog = ({ isOpen, onClose, recipe, allSections, allUnits }) => {
        if (!isOpen) return null;
        const unitMap = useMemo(() => new Map(allUnits.map(u => [u.id, u.label])), [allUnits]);

        const formatAsText = (ingredientsOnly = false) => {
            let text = '';
            if (recipe.emojis && recipe.emojis.length > 0) {
                text += `${recipe.emojis.join('')} `;
            }
            text += `${recipe.name}\n`;
            text += '====================\n\n';

            if (recipe.description && !ingredientsOnly) {
                text += `NOTES:\n${recipe.description}\n\n`;
            }

            text += 'INGREDIENTS\n----------\n';
            const { categories = [] } = recipe;
            const recipeIngredients = recipe.ingredients || [];
            
            const formatIngredientLine = (ing) => {
                const unitLabel = unitMap.get(ing.unit) || ing.unit || '';
                const quantity = ing.quantity || '';
                let line = '- ';
                if (quantity) line += `${quantity} `;
                if (unitLabel) line += `${unitLabel.toLowerCase()} `;
                line += ing.name;
                return line.replace(/  +/g, ' ').trim() + '\n';
            };

            if (categories.length > 0) {
                categories.forEach(cat => {
                    const catIngredients = recipeIngredients.filter(ing => ing.categoryId === cat.id);
                    if (catIngredients.length > 0) {
                        text += `${cat.name}:\n`;
                        catIngredients.forEach(ing => {
                            text += formatIngredientLine(ing);
                        });
                        text += '\n';
                    }
                });
                const uncategorizedIngredients = recipeIngredients.filter(ing => !ing.categoryId);
                if (uncategorizedIngredients.length > 0) {
                     if (categories.some(c => recipeIngredients.some(i => i.categoryId === c.id))) {
                        text += 'Other:\n';
                     }
                     uncategorizedIngredients.forEach(ing => {
                        text += formatIngredientLine(ing);
                     });
                     text += '\n';
                }
            } else if (recipeIngredients.length > 0) {
                recipeIngredients.forEach(ing => {
                    text += formatIngredientLine(ing);
                });
                text += '\n';
            }

            if (!ingredientsOnly) {
                text += 'STEPS\n----------\n';
                const steps = Array.isArray(recipe.steps) ? recipe.steps.map(s => typeof s === 'string' ? { text: s } : s) : [];

                if (categories.length > 0) {
                     categories.forEach(cat => {
                        const catSteps = steps.filter(step => step.categoryId === cat.id);
                        if (catSteps.length > 0) {
                            text += `${cat.name}:\n`;
                            catSteps.forEach((step, index) => {
                                text += `${index + 1}. ${step.text}\n`;
                            });
                            text += '\n';
                        }
                    });
                    const uncategorizedSteps = steps.filter(step => !step.categoryId);
                    if (uncategorizedSteps.length > 0) {
                        if (categories.some(c => steps.some(s => s.categoryId === c.id))) {
                            text += 'Other:\n';
                        }
                        uncategorizedSteps.forEach((step, index) => {
                            text += `${index + 1}. ${step.text}\n`;
                        });
                    }
                } else if (steps.length > 0) {
                    steps.forEach((step, index) => {
                        text += `${index + 1}. ${step.text}\n`;
                    });
                }
            }

            return text;
        };

        const handleShare = async (type) => {
            onClose();
            try {
                if (!navigator.share) {
                    alert('Share functionality is not supported on this browser.');
                    return;
                }

                if (type === 'full-text' || type === 'ingredients-text') {
                    const isIngredientsOnly = type === 'ingredients-text';
                    const text = formatAsText(isIngredientsOnly);
                    const title = isIngredientsOnly ? `${recipe.name} - Ingredients` : recipe.name;
                    await navigator.share({ title, text });
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                  console.error('Error sharing:', error);
                  alert(`Could not share. Error: ${error.message}`);
                }
            }
        };

        return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50", 'aria-modal': "true", role: "dialog" },
            React.createElement('div', { className: "bg-[var(--color-bg-secondary)] rounded-lg shadow-xl border border-[var(--color-border-primary)] w-full max-w-md m-4" },
                React.createElement('div', { className: "p-6" },
                    React.createElement('div', { className: "flex justify-between items-center" },
                        React.createElement('h2', { className: "text-2xl font-bold text-[var(--color-text-primary)]" }, "Share Recipe"),
                        React.createElement('button', { onClick: onClose, className: "text-[var(--color-text-tertiary)] hover:text-[var(--color-text-primary)]" },
                            React.createElement(XMarkIcon, { className: "w-6 h-6" })
                        )
                    ),
                    React.createElement('p', { className: "text-[var(--color-text-secondary)] mt-2 mb-6" }, `How would you like to share "${recipe.name}"?`)
                ),
                React.createElement('div', { className: "p-6 pt-0 flex flex-col gap-3" },
                    React.createElement('button', { onClick: () => handleShare('full-text'), className: "w-full text-left bg-[var(--color-bg-tertiary)] hover:bg-[var(--color-border-primary)] text-[var(--color-text-primary)] font-semibold py-3 px-4 rounded-md transition-colors" }, "Full Recipe"),
                    React.createElement('button', { onClick: () => handleShare('ingredients-text'), className: "w-full text-left bg-[var(--color-bg-tertiary)] hover:bg-[var(--color-border-primary)] text-[var(--color-text-primary)] font-semibold py-3 px-4 rounded-md transition-colors" }, "Ingredients Only")
                )
            )
        );
      };

      const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel }) => {
          if (!isOpen) return null;

          return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50", 'aria-modal': "true", role: "dialog" },
              React.createElement('div', { className: "bg-[var(--color-bg-secondary)] rounded-lg shadow-xl border border-[var(--color-border-primary)] w-full max-w-md m-4" },
                  React.createElement('div', { className: "p-6" },
                      React.createElement('h2', { className: "text-2xl font-bold text-[var(--color-text-primary)] mb-4" }, title),
                      React.createElement('p', { className: "text-[var(--color-text-secondary)] mb-6" }, message)
                  ),
                  React.createElement('div', { className: "bg-[var(--color-bg-tertiary)] px-6 py-4 flex justify-end gap-4 rounded-b-lg" },
                      React.createElement('button', { onClick: onCancel, className: "bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-4 rounded-md" }, "Cancel"),
                      React.createElement('button', { onClick: onConfirm, className: "bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md" }, "Confirm")
                  )
              )
          );
      };
      
      const AddUnitDialog = ({ isOpen, onSave, onCancel }) => {
          if (!isOpen) return null;
          const [label, setLabel] = useState('');

          const handleSave = () => {
              const trimmed = label.trim();
              if (trimmed) {
                  onSave(trimmed);
                  setLabel('');
              }
          };

          return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50", 'aria-modal': "true", role: "dialog" },
              React.createElement('div', { className: "bg-[var(--color-bg-secondary)] rounded-lg shadow-xl border border-[var(--color-border-primary)] w-full max-w-md m-4" },
                  React.createElement('div', { className: "p-6" },
                      React.createElement('h2', { className: "text-2xl font-bold text-[var(--color-text-primary)] mb-4" }, "Add New Unit"),
                      React.createElement('p', { className: "text-[var(--color-text-tertiary)] mb-2" }, "Enter the name for the new measurement unit."),
                      React.createElement('input', {
                          type: "text",
                          value: label,
                          onChange: e => setLabel(e.target.value),
                          placeholder: "e.g., Pinch, Dash, etc.",
                          className: "w-full p-3 bg-[var(--color-bg-input)] border border-[var(--color-border-secondary)] rounded-md text-[var(--color-text-primary)] focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)]"
                      })
                  ),
                  React.createElement('div', { className: "bg-[var(--color-bg-tertiary)] px-6 py-4 flex justify-end gap-4 rounded-b-lg" },
                      React.createElement('button', { onClick: onCancel, className: "bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-4 rounded-md" }, "Cancel"),
                      React.createElement('button', { onClick: handleSave, className: "bg-[var(--color-accent)] hover:brightness-95 text-white font-bold py-2 px-4 rounded-md" }, "Save")
                  )
              )
          );
      };

      const App = () => {
        const [recipes, setRecipes] = useLocalStorage('recipes', []);
        const [sections, setSections] = useLocalStorage('sections', []);
        const [units, setUnits] = useLocalStorage('units', DEFAULT_UNITS);
        const [shoppingList, setShoppingList] = useLocalStorage('shoppingList', []);
        const [textSize, setTextSize] = useLocalStorage('textSize', 1);
        const [ownerName, setOwnerName] = useLocalStorage('ownerName', 'Sharn√©');
        const [view, setView] = useState({ page: 'list' });
        const [confirmState, setConfirmState] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
        const [addUnitState, setAddUnitState] = useState({ isOpen: false, onSave: (newUnit) => {} });

        useEffect(() => {
            const root = document.documentElement;
            const theme = DEFAULT_THEME;
            
            root.style.setProperty('--color-bg-primary', theme.backgroundColor);
            root.style.setProperty('--color-bg-secondary', '#1f2937');
            root.style.setProperty('--color-bg-tertiary', '#374151');
            root.style.setProperty('--color-bg-input', '#374151');
            root.style.setProperty('--color-text-primary', '#f9fafb');
            root.style.setProperty('--color-text-secondary', '#d1d5db');
            root.style.setProperty('--color-text-tertiary', '#9ca3af');
            root.style.setProperty('--color-border-primary', '#374151');
            root.style.setProperty('--color-border-secondary', '#4b5563');
            
            root.style.setProperty('--color-accent', theme.accentColor);
            root.style.setProperty('--color-accent-text', theme.accentColor);
            document.body.style.backgroundColor = 'var(--color-bg-primary)';
            document.body.style.color = 'var(--color-text-primary)';
        }, []);

        useEffect(() => {
            // 16px is a common browser default base font size.
            // Multiplying it scales all rem-based units in the app.
            document.documentElement.style.fontSize = `${16 * textSize}px`;
        }, [textSize]);

        const showConfirmDialog = (title, message, onConfirm) => {
            setConfirmState({ isOpen: true, title, message, onConfirm });
        };

        const handleConfirmAction = () => {
            confirmState.onConfirm();
            setConfirmState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
        };

        const handleCancelAction = () => {
            setConfirmState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
        };
        
        const showAddUnitDialog = (onSaveCallback) => {
            setAddUnitState({ isOpen: true, onSave: onSaveCallback });
        };
        
        const handleSaveNewUnit = (label) => {
            const newUnit = handleAddUnit(label);
            addUnitState.onSave(newUnit);
            setAddUnitState({ isOpen: false, onSave: () => {} });
        };

        const handleCancelNewUnit = () => {
            setAddUnitState({ isOpen: false, onSave: () => {} });
        };
        
        const handleAddUnit = (label) => {
          const trimmed = label.trim();
          if (!trimmed || units.some(u => u.label.toLowerCase() === trimmed.toLowerCase())) {
            alert('This unit already exists.');
            return units.find(u => u.label.toLowerCase() === trimmed.toLowerCase());
          }
          const newUnit = { id: `unit_${Date.now()}`, label: trimmed };
          setUnits(prev => [...prev, newUnit]);
          return newUnit;
        };

        const handleDeleteUnit = (id) => {
          setUnits(prev => prev.filter(u => u.id !== id));
        };

        const handleAddSection = (name) => {
            const trimmedName = name.trim();
            if (!trimmedName) return undefined;

            const existing = sections.find(s => s.name.trim().toLowerCase() === trimmedName.toLowerCase());
            if (existing) {
                alert("A section with this name already exists.");
                return existing;
            }
            
            const newSection = { id: Date.now().toString(), name: trimmedName };
            setSections(prev => [...prev, newSection]);
            return newSection;
        };
        
        const handleDeleteSection = (id) => {
            setSections(prev => prev.filter(s => s.id !== id));
        };

        const handleSaveRecipe = (recipeData) => {
            const finalRecipeData = { ...recipeData };
            if ('sectionId' in finalRecipeData) {
                delete finalRecipeData.sectionId;
            }

            if (finalRecipeData.id) {
                setRecipes(recipes.map(r => r.id === finalRecipeData.id ? finalRecipeData : r));
            } else {
                const newRecipe = {
                ...finalRecipeData,
                ingredients: finalRecipeData.ingredients.map(ing => ({...ing, id: ing.id || `${Date.now()}-${Math.random()}`})),
                id: Date.now().toString(),
                };
                setRecipes([...recipes, newRecipe]);
            }
            setView({ page: 'list' });
        };

        const handleDeleteRecipe = (id) => {
          setRecipes(recipes.filter(r => r.id !== id));
          setView({ page: 'list' });
        };

        const handleAddShoppingItem = (text) => {
            const newItem = { id: `item_${Date.now()}_${Math.random()}`, text, completed: false };
            setShoppingList(prev => [...prev, newItem]);
        };
        
        const handleAddIngredientsToShoppingList = (items) => {
            const newItems = items.map(text => ({
                id: `item_${Date.now()}_${Math.random()}`,
                text,
                completed: false
            }));
            setShoppingList(prev => [...prev, ...newItems]);
        };

        const handleToggleShoppingItem = (id) => {
            setShoppingList(prev => prev.map(item => item.id === id ? { ...item, completed: !item.completed } : item));
        };

        const handleDeleteShoppingItem = (id) => {
            setShoppingList(prev => prev.filter(item => item.id !== id));
        };

        const handleClearShoppingList = () => {
            setShoppingList([]);
        };

        const handleExport = () => {
          const dataToExport = { recipes, sections, units, shoppingList };
          const jsonString = JSON.stringify(dataToExport, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `sharnes-recipes-backup-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };
        
        const handleFileSelect = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
              try {
                  const text = e.target?.result;
                  const data = JSON.parse(text);
                  if (data.recipes || data.sections || data.units || data.shoppingList) {
                      setView({ page: 'import_confirm', data });
                  } else {
                      alert('Invalid file format. The file must contain at least one of: recipes, sections, units, or shoppingList.');
                  }
              } catch (error) {
                  alert('Error reading or parsing file.');
                  console.error(error);
              }
          };
          reader.readAsText(file);
          event.target.value = '';
        };

        const handleConfirmImport = (selectedRecipes, selectedSections, selectedUnits, selectedShoppingList) => {
            // Merge Sections
            const newSections = [...sections];
            const sectionIdMap = new Map();
            const existingSectionNames = new Set(sections.map(s => s.name.trim().toLowerCase()));
            
            selectedSections.forEach(importedSection => {
                if (!existingSectionNames.has(importedSection.name.trim().toLowerCase())) {
                    const newSection = { ...importedSection, id: `${Date.now()}-s-${importedSection.name}` };
                    newSections.push(newSection);
                    sectionIdMap.set(importedSection.id, newSection.id);
                    existingSectionNames.add(newSection.name.trim().toLowerCase());
                } else {
                    const existingSection = sections.find(s => s.name.trim().toLowerCase() === importedSection.name.trim().toLowerCase());
                    sectionIdMap.set(importedSection.id, existingSection.id);
                }
            });
            setSections(newSections);

            // Merge Recipes
            const recipesToAdd = selectedRecipes.map(importedRecipe => {
                const newId = `${Date.now()}-r-${importedRecipe.name}`;
                const newIngredients = importedRecipe.ingredients.map(ing => ({ ...ing, id: `${newId}-i-${ing.name}-${Math.random()}` }));
                const targetSectionIds = new Set(importedRecipe.sectionIds || (importedRecipe.sectionId ? [importedRecipe.sectionId] : []));
                const mappedSectionIds = Array.from(targetSectionIds).map(id => sectionIdMap.get(id)).filter(Boolean);

                const finalRecipe = {
                    ...importedRecipe,
                    id: newId,
                    ingredients: newIngredients,
                    sectionIds: mappedSectionIds,
                };
                delete finalRecipe.sectionId;
                return finalRecipe;
            });
            setRecipes(prev => [...prev, ...recipesToAdd]);
            
            // Merge Units
            const existingUnitLabels = new Set(units.map(u => u.label.trim().toLowerCase()));
            const unitsToAdd = selectedUnits.filter(u => !existingUnitLabels.has(u.label.trim().toLowerCase()));
            setUnits(prev => [...prev, ...unitsToAdd]);
            
            // Merge Shopping List
            const existingShoppingListText = new Set(shoppingList.map(i => i.text.trim().toLowerCase()));
            const shoppingListItemsToAdd = selectedShoppingList.filter(i => !existingShoppingListText.has(i.text.trim().toLowerCase()));
            setShoppingList(prev => [...prev, ...shoppingListItemsToAdd]);

            setView({ page: 'list' });
        };

        const renderContent = () => {
          switch (view.page) {
            case 'list':
              return React.createElement(RecipeList, {
                recipes: recipes,
                sections: sections,
                onSelectRecipe: (id) => setView({ page: 'detail', id }),
                onAddRecipe: () => setView({ page: 'form' }),
                onGoToSettings: () => setView({ page: 'settings' }),
                onGoToShoppingList: () => setView({ page: 'shopping_list' }),
                onGoToTimers: () => setView({ page: 'timers' }),
                onExport: handleExport,
                onFileSelect: handleFileSelect,
                ownerName: ownerName
              });
            case 'detail':
              const selectedRecipe = recipes.find(r => r.id === view.id);
              if (!selectedRecipe) {
                  setView({ page: 'list' });
                  return null;
              }
              return React.createElement(RecipeDetail, {
                recipe: selectedRecipe,
                units: units,
                sections: sections,
                onBack: () => setView({ page: 'list' }),
                onEdit: (id) => setView({ page: 'form', id }),
                onDelete: handleDeleteRecipe,
                showConfirmDialog: showConfirmDialog,
                onAddIngredientsToShoppingList: handleAddIngredientsToShoppingList
              });
            case 'form':
              const recipeToEdit = view.id ? recipes.find(r => r.id === view.id) : undefined;
              return React.createElement(RecipeForm, {
                initialRecipe: recipeToEdit,
                sections: sections,
                units: units,
                onSave: handleSaveRecipe,
                onCancel: () => setView({ page: 'list' }),
                onAddSection: handleAddSection,
                showConfirmDialog: showConfirmDialog,
                showAddUnitDialog: showAddUnitDialog
              });
            case 'settings':
              return React.createElement(Settings, {
                textSize: textSize,
                setTextSize: setTextSize,
                units: units,
                onAddUnit: handleAddUnit,
                onDeleteUnit: handleDeleteUnit,
                sections: sections,
                recipes: recipes,
                onAddSection: handleAddSection,
                onDeleteSection: handleDeleteSection,
                onBack: () => setView({ page: 'list' }),
                showConfirmDialog: showConfirmDialog,
                ownerName: ownerName,
                setOwnerName: setOwnerName
              });
            case 'shopping_list':
              return React.createElement(ShoppingList, {
                items: shoppingList,
                onAddItem: handleAddShoppingItem,
                onToggleItem: handleToggleShoppingItem,
                onDeleteItem: handleDeleteShoppingItem,
                onClearAll: handleClearShoppingList,
                onBack: () => setView({ page: 'list' }),
                showConfirmDialog: showConfirmDialog,
              });
            case 'timers':
                return React.createElement(Timers, {
                    onBack: () => setView({ page: 'list' }),
                    showConfirmDialog: showConfirmDialog,
                });
            case 'import_confirm':
              return React.createElement(ImportConfirmation, {
                data: view.data,
                onConfirm: handleConfirmImport,
                onCancel: () => setView({ page: 'list' })
              });
            default:
              return React.createElement('div', null, 'Unknown view');
          }
        };

        return (
          React.createElement('div', { className: "min-h-screen font-sans" },
            React.createElement('main', null, renderContent()),
            React.createElement(ConfirmDialog, {
                isOpen: confirmState.isOpen,
                title: confirmState.title,
                message: confirmState.message,
                onConfirm: handleConfirmAction,
                onCancel: handleCancelAction,
            }),
            React.createElement(AddUnitDialog, {
                isOpen: addUnitState.isOpen,
                onSave: handleSaveNewUnit,
                onCancel: handleCancelNewUnit,
            })
          )
        );
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        React.createElement(React.StrictMode, null, 
          React.createElement(App, null)
        )
      );
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        const swContent = `const CACHE_NAME = 'sharnes-recipes-cache-v1';
const urlsToCache = [
  '/',
  'index.html',
  'cropped.png',
  'https://cdn.tailwindcss.com',
  'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap',
  'https://aistudiocdn.com/react@^19.1.1',
  'https://aistudiocdn.com/react-dom@^19.1.1/client'
];

self.addEventListener('install', event => {
  // Perform install steps
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        console.log('Opened cache');
        return cache.addAll(urlsToCache);
      })
  );
});

self.addEventListener('fetch', event => {
  // This is a network-first strategy.
  // It tries to get the response from the network, and if it fails (offline),
  // it tries to get it from the cache.
  event.respondWith(
    fetch(event.request).catch(() => {
      return caches.match(event.request);
    })
  );
});

self.addEventListener('activate', event => {
  const cacheWhitelist = [CACHE_NAME];
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheWhitelist.indexOf(cacheName) === -1) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});`;
        window.addEventListener('load', () => {
          const blob = new Blob([swContent], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(blob);
          navigator.serviceWorker.register(swUrl)
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
  </body>
</html>
